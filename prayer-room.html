<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Prayer Room</title>
  <style>
    :root{
      --bg:#efe7d5;
      --red:#a40000;
      --green:#1e6e2f;
      --blue:#1f3c8a;
      --gold:#f0c200;

      --card:#ffffff;
      --ink:#111;

      --radius:14px;
      --gap:14px;

      --topbar-h:66px;
      --scripture-h:165px;
      --doctrine-h:175px;

      --shadow: 0 2px 8px rgba(0,0,0,.12);
      --border: 3px solid rgba(0,0,0,.12);
    }

    /* LOCK VIEWPORT: no page scroll */
    html, body { height:100%; margin:0; overflow:hidden; background:var(--bg); color:var(--ink); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }

    .app{
      height:100vh;
      display:flex;
      flex-direction:column;
    }

    .topbar{
      height:var(--topbar-h);
      background:var(--red);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 18px;
      box-sizing:border-box;
      font-weight:800;
      letter-spacing:.2px;
    }
    .topbar .title{
      font-size:22px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .topbar .actions{
      display:flex; gap:10px; align-items:center;
    }
    .btn{
      border:0;
      padding:10px 14px;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
      box-shadow: 0 1px 2px rgba(0,0,0,.12);
    }
    .btn.light{ background:#fff; color:#111; }
    .btn.gold{ background:#fff3c4; color:#111; }
    .btn.small{ padding:8px 12px; border-radius:12px; font-weight:800; }
    .btn:active{ transform: translateY(1px); }

    .content{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:var(--gap);
      padding:var(--gap);
      box-sizing:border-box;
      overflow:hidden; /* critical */
    }

    .row{
      display:flex;
      gap:var(--gap);
      overflow:hidden;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:var(--border);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0; /* critical for internal scrolling */
    }

    .cardHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      font-weight:900;
      font-size:18px;
      line-height:1.1;
    }

    .cardHeader .right{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .cardBody{
      padding:12px 14px;
      min-height:0;
      flex:1;
      overflow:auto; /* internal scroll lives here */
      box-sizing:border-box;
    }

    /* Scripture */
    .scripture.card{ height:var(--scripture-h); background:#e8f6ea; border-color:rgba(30,110,47,.45); }
    .scripture .cardHeader{ color:#0f2b18; }
    .scriptureRef{
      font-weight:1000;
      font-size:20px;
      margin:0 0 10px 0;
      text-align:center;
    }
    .scriptureText{
      font-weight:900;
      font-size:18px;
      line-height:1.35;
      text-align:center;
      margin:0;
      white-space:pre-wrap;
    }

    /* Middle layout */
    .middle{ flex:1; min-height:0; }
    .left{ width:34%; background:#e9f7ec; border-color:rgba(30,110,47,.45); }
    .right{ width:66%; background:#eaf0ff; border-color:rgba(31,60,138,.45); }

    .left .cardHeader{
      background:var(--green);
      color:#fff;
      border-bottom: 2px solid rgba(0,0,0,.12);
    }
    .right .cardHeader{
      background:var(--blue);
      color:#fff;
      border-bottom: 2px solid rgba(0,0,0,.12);
    }

    textarea{
      width:100%;
      box-sizing:border-box;
      border-radius:12px;
      border:2px solid rgba(0,0,0,.18);
      padding:12px 12px;
      font-size:17px;
      font-weight:700;
      line-height:1.35;
      outline:none;
      resize:none;
      height:100%;
      min-height:0;
      background:#fff;
    }

    /* make textarea fill the card body */
    .fillArea{
      height:100%;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .fillArea textarea{ flex:1; min-height:0; }

    .helperRow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      margin:0 0 10px 0;
      flex-wrap:wrap;
    }
    .label{
      font-weight:900;
      opacity:.95;
    }
    .dateBox{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      font-weight:900;
    }
    input[type="date"]{
      border-radius:10px;
      border:2px solid rgba(0,0,0,.18);
      padding:8px 10px;
      font-weight:900;
      font-size:15px;
      background:#fff;
    }

    /* Doctrine */
    .doctrine.card{
      height:var(--doctrine-h);
      background:#0b2c5b;
      color:#fff;
      border: 4px solid var(--gold);
    }
    .doctrine .cardHeader{
      color:var(--gold);
      font-size:20px;
    }
    .doctrineText{
      margin:0;
      font-weight:900;
      font-size:17px;
      line-height:1.35;
      text-align:center;
      white-space:pre-wrap;
    }

    /* RESPONSIVE TWEAKS */
    @media (max-width: 980px){
      :root{
        --scripture-h: 175px;
        --doctrine-h: 185px;
      }
      .middle{ flex-direction:column; }
      .left, .right{ width:100%; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="title" id="topTitle">Prayer Room</div>
      <div class="actions">
        <button class="btn light" id="changeNameBtn">Change Name</button>
      </div>
    </div>

    <div class="content">

      <!-- Scripture -->
      <div class="card scripture">
        <div class="cardHeader">
          <div>Daily Scripture</div>
          <div class="right">
            <button class="btn small light" id="scrPrev">Prev</button>
            <button class="btn small light" id="scrNext">Next</button>
            <button class="btn small light" id="scrCopy">Copy</button>
          </div>
        </div>
        <div class="cardBody">
          <div class="scriptureRef" id="scrRef">Loading…</div>
          <p class="scriptureText" id="scrText"></p>
        </div>
      </div>

      <!-- Middle -->
      <div class="row middle">
        <!-- Prayer List -->
        <div class="card left">
          <div class="cardHeader">
            <div>Daily Prayer List</div>
            <div class="right">
              <button class="btn small light" id="saveList">Save List</button>
              <button class="btn small light" id="undoList">Undo</button>
            </div>
          </div>
          <div class="cardBody">
            <div class="fillArea">
              <textarea id="prayerList" placeholder="Paste or type names here…"></textarea>
            </div>
          </div>
        </div>

        <!-- Prayers & Petitions -->
        <div class="card right">
          <div class="cardHeader">
            <div>Prayers &amp; Petitions</div>
            <div class="right dateBox">
              <span class="label">Date</span>
              <input type="date" id="datePick" />
              <button class="btn small gold" id="todayBtn">Today</button>
              <button class="btn small light" id="savePrayer">Save</button>
            </div>
          </div>
          <div class="cardBody">
            <div class="fillArea">
              <div class="helperRow">
                <button class="btn small light" id="undoPrayer">Undo</button>
                <button class="btn small light" id="redoPrayer">Redo</button>
              </div>
              <textarea id="prayerText" placeholder="Write your prayers for the selected date…"></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Doctrine -->
      <div class="card doctrine">
        <div class="cardHeader">
          <div id="docTitle">Salvation Army Doctrine</div>
          <div class="right">
            <button class="btn small light" id="docPrev">Prev</button>
            <button class="btn small light" id="docNext">Next</button>
          </div>
        </div>
        <div class="cardBody">
          <p class="doctrineText" id="docText"></p>
        </div>
      </div>

    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  /* ---------------------------
     Personalization (first run)
  ---------------------------- */
  const NAME_KEY = "prayerroom_first_name_v1";
  function sanitizeName(s){
    return (s || "").trim().replace(/\s+/g," ").slice(0,24);
  }
  function getName(){
    return sanitizeName(localStorage.getItem(NAME_KEY) || "");
  }
  function setName(name){
    localStorage.setItem(NAME_KEY, sanitizeName(name));
    applyName();
  }
  function applyName(){
    const n = getName();
    const title = n ? `${n}’s Prayer Room` : "Prayer Room";
    $("topTitle").textContent = title;
    document.title = title;
  }
  function ensureName(){
    let n = getName();
    if(!n){
      n = sanitizeName(prompt("Welcome! What is your first name? (for your Prayer Room header)", "") || "");
      if(n) setName(n);
      else applyName();
    } else {
      applyName();
    }
  }
  $("changeNameBtn").onclick = () => {
    const current = getName();
    const n = sanitizeName(prompt("Update first name for this Prayer Room:", current) || "");
    if(n) setName(n);
  };

  /* ---------------------------
     Date helpers
  ---------------------------- */
  function toYMD(d){
    const dt = new Date(d.getTime());
    dt.setMinutes(dt.getMinutes() - dt.getTimezoneOffset());
    return dt.toISOString().slice(0,10);
  }
  function fromYMD(ymd){
    const [y,m,dd] = ymd.split("-").map(Number);
    return new Date(y, m-1, dd);
  }
  function dayOfYear(d){
    const start = new Date(d.getFullYear(),0,0);
    const diff = d - start;
    return Math.floor(diff / 86400000); // 1..366
  }

  /* ---------------------------
     Scripture loader
  ---------------------------- */
  const scriptureCandidates = [
    "nlt_for_app_365.json",
    "nlt_for_app.json",
    "nlt_for_app_300.json",
    "nlt_for_app_730.json"
  ];

  let scriptureData = [];
  let scriptureIndex = 0;

  async function fetchFirstAvailableJson(){
    for(const path of scriptureCandidates){
      try{
        const res = await fetch(path + "?v=" + Date.now(), {cache:"no-store"});
        if(res.ok){
          const json = await res.json();
          return {path, json};
        }
      } catch(e){}
    }
    return null;
  }

  function pickVerseIndexForDate(d, data){
    if(!Array.isArray(data) || data.length === 0) return 0;

    // If objects have a "date" field, try exact match.
    if(typeof data[0] === "object" && data[0] && "date" in data[0]){
      const ymd = toYMD(d);
      const i = data.findIndex(x => x && x.date === ymd);
      if(i >= 0) return i;
    }

    // Otherwise, use day-of-year mapping (works for 365/300/730)
    const doy = dayOfYear(d) - 1; // 0-based
    return ((doy % data.length) + data.length) % data.length;
  }

  function getRefText(item){
    if(!item) return {ref:"", text:""};
    if(typeof item === "string") return {ref:"", text:item};
    // support common shapes: {ref,text} or {reference, text} or {verse_ref, verse_text}
    const ref = item.ref || item.reference || item.verse_ref || item.scripture_ref || "";
    const text = item.text || item.verse_text || item.scripture_text || "";
    return {ref, text};
  }

  function renderScripture(){
    const item = scriptureData[scriptureIndex] || null;
    const {ref, text} = getRefText(item);
    $("scrRef").textContent = ref || "(No reference)";
    $("scrText").textContent = text || "(No text loaded)";
  }

  async function initScripture(){
    $("scrRef").textContent = "Loading…";
    $("scrText").textContent = "";
    const found = await fetchFirstAvailableJson();
    if(!found){
      $("scrRef").textContent = "No JSON file found.";
      $("scrText").textContent = "Put one of these at site root: nlt_for_app_365.json, nlt_for_app.json, nlt_for_app_300.json, nlt_for_app_730.json";
      return;
    }
    scriptureData = Array.isArray(found.json) ? found.json : [];
    scriptureIndex = pickVerseIndexForDate(fromYMD($("datePick").value), scriptureData);
    renderScripture();
  }

  $("scrPrev").onclick = () => {
    if(!scriptureData.length) return;
    scriptureIndex = (scriptureIndex - 1 + scriptureData.length) % scriptureData.length;
    renderScripture();
  };
  $("scrNext").onclick = () => {
    if(!scriptureData.length) return;
    scriptureIndex = (scriptureIndex + 1) % scriptureData.length;
    renderScripture();
  };
  $("scrCopy").onclick = async () => {
    const ref = $("scrRef").textContent.trim();
    const text = $("scrText").textContent.trim();
    const payload = (ref ? ref + "\n" : "") + text;
    try{
      await navigator.clipboard.writeText(payload);
    }catch(e){
      // fallback
      const ta = document.createElement("textarea");
      ta.value = payload;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
    }
  };

  /* ---------------------------
     Doctrine (11 rotating)
  ---------------------------- */
  const doctrines = [
    "We believe that the Scriptures of the Old and New Testaments were given by inspiration of God, and that they only constitute the Divine rule of Christian faith and practice.",
    "We believe that there is only one God, who is infinitely perfect, the Creator, Preserver, and Governor of all things, and who is the only proper object of religious worship.",
    "We believe that there are three persons in the Godhead—the Father, the Son, and the Holy Ghost, undivided in essence and co-equal in power and glory.",
    "We believe that in the person of Jesus Christ the Divine and human natures are united, so that He is truly and properly God and truly and properly man.",
    "We believe that our first parents were created in a state of innocency, but by their disobedience, they lost their purity and happiness, and that in consequence of their fall, all men have become sinners, totally depraved, and as such are justly exposed to the wrath of God.",
    "We believe that the Lord Jesus Christ has by His suffering and death made an atonement for the whole world so that whosoever will may be saved.",
    "We believe that repentance towards God, faith in our Lord Jesus Christ, and regeneration by the Holy Spirit, are necessary to salvation.",
    "We believe that we are justified by grace through faith in our Lord Jesus Christ and that he that believeth hath the witness in himself.",
    "We believe that continuance in a state of salvation depends upon continued obedient faith in Christ.",
    "We believe that it is the privilege of all believers to be wholly sanctified and that their whole spirit and soul and body may be preserved blameless unto the coming of our Lord Jesus Christ.",
    "We believe in the immortality of the soul, in the resurrection of the body, in the general judgment at the end of the world, in the eternal happiness of the righteous, and in the endless punishment of the wicked."
  ];

  let doctrineIndex = 0;

  function doctrineIndexForDate(d){
    const doy0 = dayOfYear(d) - 1;
    return ((doy0 % 11) + 11) % 11;
  }

  function renderDoctrine(){
    $("docTitle").textContent = `Salvation Army Doctrine #${doctrineIndex+1}`;
    $("docText").textContent = doctrines[doctrineIndex] || "";
  }

  $("docPrev").onclick = () => {
    doctrineIndex = (doctrineIndex - 1 + doctrines.length) % doctrines.length;
    renderDoctrine();
  };
  $("docNext").onclick = () => {
    doctrineIndex = (doctrineIndex + 1) % doctrines.length;
    renderDoctrine();
  };

  /* ---------------------------
     Prayer List (global)
  ---------------------------- */
  const LIST_KEY = "prayerroom_list_v1";
  let listUndo = [];

  function loadList(){
    const v = localStorage.getItem(LIST_KEY) || "";
    $("prayerList").value = v;
    listUndo = [v];
  }
  $("saveList").onclick = () => {
    const v = $("prayerList").value;
    localStorage.setItem(LIST_KEY, v);
    listUndo.push(v);
    if(listUndo.length > 50) listUndo.shift();
  };
  $("undoList").onclick = () => {
    if(listUndo.length <= 1) return;
    listUndo.pop();
    $("prayerList").value = listUndo[listUndo.length-1] || "";
  };

  /* ---------------------------
     Prayers by date (undo/redo)
  ---------------------------- */
  function prayerKey(ymd){ return `prayerroom_prayer_${ymd}`; }

  let prayUndo = [];
  let prayRedo = [];
  let prayLast = "";

  function loadPrayerForDate(ymd){
    const v = localStorage.getItem(prayerKey(ymd)) || "";
    $("prayerText").value = v;
    prayUndo = [v];
    prayRedo = [];
    prayLast = v;
  }

  $("savePrayer").onclick = () => {
    const ymd = $("datePick").value;
    localStorage.setItem(prayerKey(ymd), $("prayerText").value);
  };

  function pushUndoIfChanged(){
    const v = $("prayerText").value;
    if(v !== prayLast){
      prayUndo.push(v);
      if(prayUndo.length > 100) prayUndo.shift();
      prayRedo = [];
      prayLast = v;
    }
  }

  $("prayerText").addEventListener("input", () => {
    // throttle-ish: push snapshots occasionally
    // (simple approach: every input, but still capped)
    pushUndoIfChanged();
  });

  $("undoPrayer").onclick = () => {
    if(prayUndo.length <= 1) return;
    const cur = prayUndo.pop();
    prayRedo.push(cur);
    const prev = prayUndo[prayUndo.length-1] || "";
    $("prayerText").value = prev;
    prayLast = prev;
  };

  $("redoPrayer").onclick = () => {
    if(prayRedo.length === 0) return;
    const v = prayRedo.pop();
    prayUndo.push(v);
    $("prayerText").value = v;
    prayLast = v;
  };

  $("todayBtn").onclick = () => {
    const ymd = toYMD(new Date());
    $("datePick").value = ymd;
    loadPrayerForDate(ymd);

    // re-sync scripture + doctrine to date
    doctrineIndex = doctrineIndexForDate(fromYMD(ymd));
    renderDoctrine();
    scriptureIndex = pickVerseIndexForDate(fromYMD(ymd), scriptureData);
    renderScripture();
  };

  $("datePick").addEventListener("change", () => {
    const ymd = $("datePick").value;
    loadPrayerForDate(ymd);

    doctrineIndex = doctrineIndexForDate(fromYMD(ymd));
    renderDoctrine();

    scriptureIndex = pickVerseIndexForDate(fromYMD(ymd), scriptureData);
    renderScripture();
  });

  /* ---------------------------
     Boot
  ---------------------------- */
  function boot(){
    ensureName();

    const today = toYMD(new Date());
    $("datePick").value = today;

    loadList();
    loadPrayerForDate(today);

    doctrineIndex = doctrineIndexForDate(new Date());
    renderDoctrine();

    initScripture();
  }

  boot();
})();
</script>
</body>
</html>

