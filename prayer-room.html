<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Prayer Room</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f6f2e8}
.header{background:#b30000;color:#fff;padding:12px 16px;font-size:20px;font-weight:bold}
.subheader{background:#efe9d6;padding:10px 16px;font-size:14px}
.container{display:flex;gap:10px;padding:10px}
.left{width:260px;background:#e6f3e6;border:2px solid #2d7a2d;padding:6px}
.right{flex:1;background:#eef4ff;border:2px solid #1f3f99;padding:6px}
textarea{width:100%;height:420px;box-sizing:border-box}
.footer{background:#003366;color:#fff;padding:10px;text-align:center;font-size:13px}
button{margin:4px}
</style>
</head>

<body>

<div class="header" id="title">Prayer Room</div>

<div class="subheader">
Date:
<input type="date" id="datePicker">
<button id="todayBtn">Today</button>
</div>

<div class="container">

<div class="left">
<b>Daily Prayer List</b><br>
<textarea id="listBox"></textarea><br>
<button onclick="save()">Save</button>
</div>

<div class="right">
<b>Prayers & Petitions</b><br>
<textarea id="prayerBox"></textarea><br>
<button onclick="save()">Save</button>
</div>

</div>

<div class="footer">
Salvation Army Doctrine #7 â€” Repentance, faith, regeneration
</div>

<script>
/* ========= INDEXEDDB CORE ========= */

const DB_NAME = "PrayerRoomDB";
const DB_VERSION = 1;
let db;

function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = e=>{
      db = e.target.result;
      if(!db.objectStoreNames.contains("days")){
        db.createObjectStore("days",{keyPath:"date"});
      }
      if(!db.objectStoreNames.contains("user")){
        db.createObjectStore("user",{keyPath:"key"});
      }
    };
    req.onsuccess = e=>{db=e.target.result;resolve();};
    req.onerror = e=>reject(e);
  });
}

function tx(store,mode="readonly"){
  return db.transaction(store,mode).objectStore(store);
}

/* ========= USER NAME ========= */

async function loadUser(){
  return new Promise(res=>{
    const r = tx("user").get("profile");
    r.onsuccess=()=>res(r.result);
  });
}

async function saveUser(name){
  tx("user","readwrite").put({key:"profile",name});
}

async function ensureUser(){
  const u = await loadUser();
  if(!u){
    const name = prompt("Enter your first name:");
    if(name){
      await saveUser(name);
      document.getElementById("title").textContent = name+"'s Prayer Room";
    }
  }else{
    document.getElementById("title").textContent = u.name+"'s Prayer Room";
  }
}

/* ========= DAILY DATA ========= */

function currentDate(){
  return document.getElementById("datePicker").value;
}

async function loadDay(date){
  return new Promise(res=>{
    const r = tx("days").get(date);
    r.onsuccess=()=>res(r.result);
  });
}

async function save(){
  const date = currentDate();
  tx("days","readwrite").put({
    date,
    list: document.getElementById("listBox").value,
    prayer: document.getElementById("prayerBox").value
  });
}

async function restore(date){
  const d = await loadDay(date);
  document.getElementById("listBox").value = d?.list || "";
  document.getElementById("prayerBox").value = d?.prayer || "";
}

/* ========= INIT ========= */

(async()=>{
  await openDB();
  await ensureUser();

  const dp = document.getElementById("datePicker");
  dp.value = new Date().toISOString().slice(0,10);

  await restore(dp.value);

  dp.onchange = ()=>restore(dp.value);
  document.getElementById("todayBtn").onclick=()=>{
    dp.value = new Date().toISOString().slice(0,10);
    restore(dp.value);
  };

  window.addEventListener("beforeunload", save);
})();
</script>

</body>
</html>

