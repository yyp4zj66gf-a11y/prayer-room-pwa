<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Prayer Room</title>
  <style>
    :root{
      --bg:#efe7d5;
      --red:#a40000;
      --green:#1e6e2f;
      --blue:#1f3c8a;
      --gold:#f0c200;
      --card:#ffffff;
      --ink:#111;
      --radius:14px;
      --gap:12px;
      --shadow: 0 2px 8px rgba(0,0,0,.12);
      --border: 3px solid rgba(0,0,0,.12);
      --topbar-h:62px;
    }
    html, body { height:100%; margin:0; overflow:hidden; background:var(--bg); color:var(--ink); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .app{ height:100vh; display:flex; flex-direction:column; }
    .topbar{
      height:var(--topbar-h);
      background:var(--red);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 14px;
      box-sizing:border-box;
      font-weight:900;
    }
    .topbar .title{ font-size:19px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .btn{
      border:0; padding:9px 12px; border-radius:12px;
      font-weight:900; cursor:pointer;
      box-shadow: 0 1px 2px rgba(0,0,0,.12);
    }
    .btn.light{ background:#fff; color:#111; }
    .btn.gold{ background:#fff3c4; color:#111; }
    .btn.small{ padding:8px 11px; }

    .content{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:var(--gap);
      padding:var(--gap);
      box-sizing:border-box;
      overflow:hidden;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:var(--border);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .cardHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      font-weight:1000;
      font-size:16px;
      line-height:1.1;
    }
    .cardHeader .right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .cardBody{ padding:10px 12px; min-height:0; flex:1; overflow:auto; box-sizing:border-box; }

    /* heights that FIT the phone */
    .scripture{ background:#e8f6ea; border-color:rgba(30,110,47,.45); height:22vh; min-height:150px; }
    .list{ background:#e9f7ec; border-color:rgba(30,110,47,.45); height:26vh; min-height:170px; }
    .prayer{ background:#eaf0ff; border-color:rgba(31,60,138,.45); height:32vh; min-height:220px; }
    .doctrine{ background:#0b2c5b; color:#fff; border:4px solid var(--gold); height:18vh; min-height:150px; }

    .list .cardHeader{ background:var(--green); color:#fff; }
    .prayer .cardHeader{ background:var(--blue); color:#fff; }
    .doctrine .cardHeader{ color:var(--gold); }

    textarea{
      width:100%;
      box-sizing:border-box;
      border-radius:12px;
      border:2px solid rgba(0,0,0,.18);
      padding:12px 12px;
      font-size:16px;
      font-weight:800;
      line-height:1.35;
      outline:none;
      resize:none;
      height:100%;
      min-height:0;
      background:#fff;
    }
    .fillArea{ height:100%; display:flex; flex-direction:column; min-height:0; }
    .fillArea textarea{ flex:1; min-height:0; }

    .scriptureRef{ font-weight:1000; font-size:18px; margin:0 0 8px 0; text-align:center; }
    .scriptureText{ font-weight:900; font-size:16px; line-height:1.35; margin:0; text-align:center; white-space:pre-wrap; }

    .doctrineText{ margin:0; font-weight:900; font-size:15px; line-height:1.35; text-align:center; white-space:pre-wrap; }

    input[type="date"]{
      border-radius:10px;
      border:2px solid rgba(0,0,0,.18);
      padding:7px 9px;
      font-weight:900;
      font-size:14px;
      background:#fff;
    }

    @media (max-width: 380px){
      .scriptureText{ font-size:15px; }
      textarea{ font-size:15px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="title" id="topTitle">Prayer Room</div>
      <button class="btn light" id="changeNameBtn">Name</button>
    </div>

    <div class="content">

      <div class="card scripture">
        <div class="cardHeader">
          <div>Daily Scripture</div>
          <div class="right">
            <button class="btn small light" id="scrPrev">Prev</button>
            <button class="btn small light" id="scrNext">Next</button>
            <button class="btn small light" id="scrCopy">Copy</button>
          </div>
        </div>
        <div class="cardBody">
          <div class="scriptureRef" id="scrRef">Loading…</div>
          <p class="scriptureText" id="scrText"></p>
        </div>
      </div>

      <div class="card list">
        <div class="cardHeader">
          <div>Daily Prayer List</div>
          <div class="right">
            <button class="btn small light" id="saveList">Save</button>
            <button class="btn small light" id="undoList">Undo</button>
          </div>
        </div>
        <div class="cardBody">
          <div class="fillArea">
            <textarea id="prayerList" placeholder="Paste or type names here…"></textarea>
          </div>
        </div>
      </div>

      <div class="card prayer">
        <div class="cardHeader">
          <div>Prayers &amp; Petitions</div>
          <div class="right">
            <input type="date" id="datePick" />
            <button class="btn small gold" id="todayBtn">Today</button>
            <button class="btn small light" id="savePrayer">Save</button>
          </div>
        </div>
        <div class="cardBody">
          <div class="fillArea">
            <div style="display:flex; gap:10px; justify-content:flex-end; margin:0 0 10px 0;">
              <button class="btn small light" id="undoPrayer">Undo</button>
              <button class="btn small light" id="redoPrayer">Redo</button>
            </div>
            <textarea id="prayerText" placeholder="Write your prayers for the selected date…"></textarea>
          </div>
        </div>
      </div>

      <div class="card doctrine">
        <div class="cardHeader">
          <div id="docTitle">Salvation Army Doctrine</div>
          <div class="right">
            <button class="btn small light" id="docPrev">Prev</button>
            <button class="btn small light" id="docNext">Next</button>
          </div>
        </div>
        <div class="cardBody">
          <p class="doctrineText" id="docText"></p>
        </div>
      </div>

    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const NAME_KEY = "prayerroom_first_name_v1";
  const sanitizeName = (s) => (s||"").trim().replace(/\s+/g," ").slice(0,24);
  const getName = () => sanitizeName(localStorage.getItem(NAME_KEY) || "");
  const applyName = () => {
    const n = getName();
    const title = n ? `${n}’s Prayer Room` : "Prayer Room";
    $("topTitle").textContent = title;
    document.title = title;
  };
  const ensureName = () => {
    let n = getName();
    if(!n){
      n = sanitizeName(prompt("Welcome! What is your first name? (for your Prayer Room header)", "") || "");
      if(n) localStorage.setItem(NAME_KEY, n);
    }
    applyName();
  };
  $("changeNameBtn").onclick = () => {
    const cur = getName();
    const n = sanitizeName(prompt("Update first name:", cur) || "");
    if(n){ localStorage.setItem(NAME_KEY, n); }
    applyName();
  };

  function toYMD(d){
    const dt = new Date(d.getTime());
    dt.setMinutes(dt.getMinutes() - dt.getTimezoneOffset());
    return dt.toISOString().slice(0,10);
  }
  function fromYMD(ymd){
    const [y,m,dd] = ymd.split("-").map(Number);
    return new Date(y, m-1, dd);
  }
  function dayOfYear(d){
    const start = new Date(d.getFullYear(),0,0);
    return Math.floor((d - start) / 86400000);
  }

  const scriptureCandidates = ["nlt_for_app_365.json","nlt_for_app.json","nlt_for_app_300.json","nlt_for_app_730.json"];
  let scriptureData = [];
  let scriptureIndex = 0;

  async function fetchFirstAvailableJson(){
    for(const path of scriptureCandidates){
      try{
        const res = await fetch(path + "?v=" + Date.now(), {cache:"no-store"});
        if(res.ok) return await res.json();
      }catch(e){}
    }
    return null;
  }

  function pickVerseIndexForDate(d, data){
    if(!Array.isArray(data) || data.length === 0) return 0;
    if(typeof data[0] === "object" && data[0] && "date" in data[0]){
      const ymd = toYMD(d);
      const i = data.findIndex(x => x && x.date === ymd);
      if(i >= 0) return i;
    }
    const doy0 = dayOfYear(d) - 1;
    return ((doy0 % data.length) + data.length) % data.length;
  }

  function getRefText(item){
    if(!item) return {ref:"", text:""};
    if(typeof item === "string") return {ref:"", text:item};
    return {
      ref: item.ref || item.reference || item.verse_ref || item.scripture_ref || "",
      text: item.text || item.verse_text || item.scripture_text || ""
    };
  }

  function renderScripture(){
    const item = scriptureData[scriptureIndex] || null;
    const {ref, text} = getRefText(item);
    $("scrRef").textContent = ref || "(No reference)";
    $("scrText").textContent = text || "(No text loaded)";
  }

  async function initScripture(){
    $("scrRef").textContent = "Loading…";
    $("scrText").textContent = "";
    const json = await fetchFirstAvailableJson();
    if(!json){
      $("scrRef").textContent = "No JSON file found.";
      $("scrText").textContent = "Put one of these at site root: nlt_for_app_365.json, nlt_for_app.json, nlt_for_app_300.json, nlt_for_app_730.json";
      return;
    }
    scriptureData = Array.isArray(json) ? json : [];
    scriptureIndex = pickVerseIndexForDate(fromYMD($("datePick").value), scriptureData);
    renderScripture();
  }

  $("scrPrev").onclick = () => { if(scriptureData.length){ scriptureIndex = (scriptureIndex-1+scriptureData.length)%scriptureData.length; renderScripture(); } };
  $("scrNext").onclick = () => { if(scriptureData.length){ scriptureIndex = (scriptureIndex+1)%scriptureData.length; renderScripture(); } };
  $("scrCopy").onclick = async () => {
    const payload = ($("scrRef").textContent.trim() ? $("scrRef").textContent.trim()+"\n" : "") + $("scrText").textContent.trim();
    try{ await navigator.clipboard.writeText(payload); }
    catch(e){
      const ta = document.createElement("textarea");
      ta.value = payload; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); ta.remove();
    }
  };

  const doctrines = [
    "We believe that the Scriptures of the Old and New Testaments were given by inspiration of God, and that they only constitute the Divine rule of Christian faith and practice.",
    "We believe that there is only one God, who is infinitely perfect, the Creator, Preserver, and Governor of all things, and who is the only proper object of religious worship.",
    "We believe that there are three persons in the Godhead—the Father, the Son, and the Holy Ghost, undivided in essence and co-equal in power and glory.",
    "We believe that in the person of Jesus Christ the Divine and human natures are united, so that He is truly and properly God and truly and properly man.",
    "We believe that our first parents were created in a state of innocency, but by their disobedience, they lost their purity and happiness, and that in consequence of their fall, all men have become sinners, totally depraved, and as such are justly exposed to the wrath of God.",
    "We believe that the Lord Jesus Christ has by His suffering and death made an atonement for the whole world so that whosoever will may be saved.",
    "We believe that repentance towards God, faith in our Lord Jesus Christ, and regeneration by the Holy Spirit, are necessary to salvation.",
    "We believe that we are justified by grace through faith in our Lord Jesus Christ and that he that believeth hath the witness in himself.",
    "We believe that continuance in a state of salvation depends upon continued obedient faith in Christ.",
    "We believe that it is the privilege of all believers to be wholly sanctified and that their whole spirit and soul and body may be preserved blameless unto the coming of our Lord Jesus Christ.",
    "We believe in the immortality of the soul, in the resurrection of the body, in the general judgment at the end of the world, in the eternal happiness of the righteous, and in the endless punishment of the wicked."
  ];
  let doctrineIndex = 0;
  const doctrineIndexForDate = (d) => ((dayOfYear(d)-1) % 11 + 11) % 11;
  const renderDoctrine = () => { $("docTitle").textContent = `Salvation Army Doctrine #${doctrineIndex+1}`; $("docText").textContent = doctrines[doctrineIndex] || ""; };
  $("docPrev").onclick = () => { doctrineIndex = (doctrineIndex-1+doctrines.length)%doctrines.length; renderDoctrine(); };
  $("docNext").onclick = () => { doctrineIndex = (doctrineIndex+1)%doctrines.length; renderDoctrine(); };

  const LIST_KEY = "prayerroom_list_v1";
  let listUndo = [];
  const loadList = () => { const v = localStorage.getItem(LIST_KEY)||""; $("prayerList").value=v; listUndo=[v]; };
  $("saveList").onclick = () => { const v=$("prayerList").value; localStorage.setItem(LIST_KEY,v); listUndo.push(v); if(listUndo.length>50) listUndo.shift(); };
  $("undoList").onclick = () => { if(listUndo.length<=1) return; listUndo.pop(); $("prayerList").value=listUndo[listUndo.length-1]||""; };

  const prayerKey = (ymd) => `prayerroom_prayer_${ymd}`;
  let prayUndo=[], prayRedo=[], prayLast="";
  const loadPrayerForDate = (ymd) => { const v=localStorage.getItem(prayerKey(ymd))||""; $("prayerText").value=v; prayUndo=[v]; prayRedo=[]; prayLast=v; };
  $("savePrayer").onclick = () => { const ymd=$("datePick").value; localStorage.setItem(prayerKey(ymd), $("prayerText").value); };
  const pushUndoIfChanged = () => { const v=$("prayerText").value; if(v!==prayLast){ prayUndo.push(v); if(prayUndo.length>100) prayUndo.shift(); prayRedo=[]; prayLast=v; } };
  $("prayerText").addEventListener("input", pushUndoIfChanged);
  $("undoPrayer").onclick = () => { if(prayUndo.length<=1) return; const cur=prayUndo.pop(); prayRedo.push(cur); const prev=prayUndo[prayUndo.length-1]||""; $("prayerText").value=prev; prayLast=prev; };
  $("redoPrayer").onclick = () => { if(!prayRedo.length) return; const v=prayRedo.pop(); prayUndo.push(v); $("prayerText").value=v; prayLast=v; };

  $("todayBtn").onclick = () => {
    const ymd = toYMD(new Date());
    $("datePick").value = ymd;
    loadPrayerForDate(ymd);
    doctrineIndex = doctrineIndexForDate(fromYMD(ymd));
    renderDoctrine();
    scriptureIndex = pickVerseIndexForDate(fromYMD(ymd), scriptureData);
    renderScripture();
  };
  $("datePick").addEventListener("change", () => {
    const ymd = $("datePick").value;
    loadPrayerForDate(ymd);
    doctrineIndex = doctrineIndexForDate(fromYMD(ymd));
    renderDoctrine();
    scriptureIndex = pickVerseIndexForDate(fromYMD(ymd), scriptureData);
    renderScripture();
  });

  function boot(){
    ensureName();
    const today = toYMD(new Date());
    $("datePick").value = today;
    loadList();
    loadPrayerForDate(today);
    doctrineIndex = doctrineIndexForDate(new Date());
    renderDoctrine();
    initScripture();
  }
  boot();
})();
</script>
</body>
</html>

