<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lorne’s Prayer Room</title>
  <style>
    :root{
      --bg: #efe7d3;
      --card: #f6f8fb;
      --ink: #0f172a;
      --muted: #475569;

      --sa-red: #b30000;
      --green: #166534;
      --green-2: #eaf6ee;

      --blue: #1e3a8a;
      --blue-2: #eef4ff;

      --gold: #f6c400;
      --shadow: 0 8px 24px rgba(0,0,0,.08);
      --radius: 16px;
    }

    /* LOCK PAGE TO VIEWPORT (no whole-page scroll) */
    html, body { height: 100%; }
    body{
      margin: 0;
      overflow: hidden;
      background: var(--bg);
      color: var(--ink);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    .topbar{
      background: var(--sa-red);
      color: white;
      padding: 14px 18px;
      font-weight: 800;
      letter-spacing: .2px;
      font-size: 22px;
    }

    /* viewport-fixed app frame */
    .frame{
      height: calc(100vh - 56px);
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 14px;
      box-sizing: border-box;
    }

    .app{
      width: min(1220px, 96vw);
      height: 100%;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card{
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid rgba(15,23,42,.08);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 0; /* IMPORTANT for internal scrolling */
    }

    .cardHeader{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      gap: 10px;
      font-weight: 800;
      font-size: 18px;
    }

    .subbar{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(15,23,42,.06);
      border-radius: 12px;
    }

    .btn{
      border: 1px solid rgba(15,23,42,.20);
      background: #fff;
      border-radius: 10px;
      padding: 8px 12px;
      font-weight: 750;
      cursor: pointer;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(15,23,42,.18);
      background: #fff7db;
    }

    .pill{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      color: var(--muted);
      font-size: 14px;
    }
    input[type="date"]{
      border: 1px solid rgba(15,23,42,.20);
      border-radius: 10px;
      padding: 8px 10px;
      font-weight: 650;
      font-size: 14px;
      background: white;
    }

    /* Scripture card */
    .scripture{
      border: 3px solid rgba(22,101,52,.55);
      background: var(--green-2);
    }
    .scripture .cardHeader{ background: transparent; }
    .scriptureTools{
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .scriptureBody{
      padding: 8px 12px 12px;
      min-height: 0;
    }
    .scriptureRef{
      font-weight: 900;
      font-size: 18px;
      margin-bottom: 6px;
    }
    .scriptureText{
      font-size: 18px;
      font-weight: 700;
      line-height: 1.35;
      white-space: pre-wrap;
      background: rgba(255,255,255,.70);
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 12px;
      padding: 10px 12px;
      height: 100%;
      min-height: 66px;
      overflow: auto; /* scroll ONLY inside this box if ever needed */
      box-sizing: border-box;
    }

    /* Middle row fills remaining height */
    .middle{
      flex: 1;
      min-height: 0;
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 12px;
    }

    /* Prayer list */
    .listCard{ border: 3px solid rgba(22,101,52,.55); background: #f1fbf4; }
    .listCard .cardHeader{ background: var(--green); color: white; }
    .listBody{
      padding: 10px;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    textarea{
      width: 100%;
      border: 1px solid rgba(15,23,42,.18);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 16px;
      font-weight: 650;
      line-height: 1.35;
      box-sizing: border-box;
      resize: none;
      outline: none;
      background: #fff;
    }
    .listArea{
      flex: 1;
      min-height: 0;
      overflow: auto; /* scroll ONLY inside textarea */
    }
    .rowBtns{ display: flex; gap: 8px; justify-content: flex-end; }

    /* Prayers & petitions */
    .prayersCard{ border: 3px solid rgba(30,58,138,.55); background: var(--blue-2); }
    .prayersCard .cardHeader{ background: var(--blue); color: white; }
    .prayersBody{
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
    }
    .prayersArea{
      flex: 1;
      min-height: 0;
      overflow: auto;
    }
    .bottomBtns{ display: flex; gap: 8px; justify-content: flex-start; }

    /* Doctrine */
    .doctrine{
      border: 4px solid var(--gold);
      background: #0b3b78;
      color: white;
    }
    .doctrineHeader{
      padding: 10px 12px 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-weight: 900;
      font-size: 18px;
    }
    .doctrineTitle{
      font-weight: 900;
      font-size: 20px;
      color: var(--gold);
      text-align: center;
    }
    .doctrineBody{
      padding: 0 12px 12px;
      min-height: 0;
    }
    .doctrineText{
      font-size: 16px;
      font-weight: 750;
      line-height: 1.28;
      white-space: normal;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.22);
      border-radius: 12px;
      padding: 10px 12px;
      max-height: 110px;
      overflow: auto; /* scroll ONLY in doctrine box if ever needed */
      box-sizing: border-box;
    }

    /* Make sure the overall container never forces page scroll */
    .scripture, .doctrine { flex: 0 0 auto; }
  </style>
</head>

<body>
  <div class="topbar">Lorne’s Prayer Room</div>

  <div class="frame">
    <div class="app">

      <!-- DAILY SCRIPTURE -->
      <section class="card scripture" id="scriptureCard">
        <div class="cardHeader">
          <div>Daily Scripture</div>
          <div class="scriptureTools">
            <button class="btn" id="prevScripture">Prev</button>
            <button class="btn" id="nextScripture">Next</button>
            <button class="btn" id="copyScripture">Copy</button>
          </div>
        </div>
        <div class="scriptureBody">
          <div class="scriptureRef" id="scriptureRef">Loading…</div>
          <div class="scriptureText" id="scriptureText">Loading scripture…</div>
        </div>
      </section>

      <!-- MIDDLE ROW -->
      <section class="middle">

        <!-- DAILY PRAYER LIST -->
        <div class="card listCard">
          <div class="cardHeader">
            <div>Daily Prayer List</div>
            <div class="rowBtns">
              <button class="btn primary" id="saveList">Save List</button>
              <button class="btn" id="undoList">Undo</button>
            </div>
          </div>
          <div class="listBody">
            <textarea class="listArea" id="listText" placeholder="Paste or type names here…"></textarea>
          </div>
        </div>

        <!-- PRAYERS & PETITIONS -->
        <div class="card prayersCard">
          <div class="cardHeader">
            <div>Prayers &amp; Petitions</div>
            <div class="pill">
              <span>Date</span>
              <input type="date" id="prayerDate" />
              <button class="btn primary" id="todayBtn">Today</button>
              <button class="btn primary" id="savePrayer">Save</button>
            </div>
          </div>
          <div class="prayersBody">
            <textarea class="prayersArea" id="prayerText" placeholder="Write your prayers for the selected date…"></textarea>
            <div class="bottomBtns">
              <button class="btn" id="undoPrayer">Undo</button>
              <button class="btn" id="redoPrayer">Redo</button>
            </div>
          </div>
        </div>

      </section>

      <!-- DOCTRINE -->
      <section class="card doctrine">
        <div class="doctrineHeader">
          <button class="btn" id="prevDoctrine">Prev</button>
          <div class="doctrineTitle" id="doctrineTitle">Salvation Army Doctrine</div>
          <button class="btn" id="nextDoctrine">Next</button>
        </div>
        <div class="doctrineBody">
          <div class="doctrineText" id="doctrineText">Loading doctrine…</div>
        </div>
      </section>

    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // ---------- Date helpers ----------
  function isoToday() {
    const d = new Date();
    const tz = d.getTimezoneOffset() * 60000;
    return new Date(d - tz).toISOString().slice(0,10);
  }
  function daysBetweenISO(a, b) {
    // a, b are YYYY-MM-DD
    const da = new Date(a + "T00:00:00");
    const db = new Date(b + "T00:00:00");
    return Math.floor((db - da) / 86400000);
  }

  // Anchor for “midnight rollover” indexing (stable)
  const ANCHOR_ISO = "2025-11-17";

  // ---------- Doctrines (rotate 1–11) ----------
  const DOCTRINES = [
    "We believe that the Scriptures of the Old and New Testaments were given by inspiration of God, and that they only constitute the Divine rule of Christian faith and practice.",
    "We believe that there is only one God, who is infinitely perfect, the Creator, Preserver, and Governor of all things, and who is the only proper object of religious worship.",
    "We believe that there are three persons in the Godhead—the Father, the Son, and the Holy Ghost, undivided in essence and co-equal in power and glory.",
    "We believe that in the person of Jesus Christ the Divine and human natures are united, so that He is truly and properly God and truly and properly man.",
    "We believe that our first parents were created in a state of innocency, but by their disobedience, they lost their purity and happiness, and that in consequence of their fall, all men have become sinners, totally depraved, and as such are justly exposed to the wrath of God.",
    "We believe that the Lord Jesus Christ has by His suffering and death made an atonement for the whole world so that whosoever will may be saved.",
    "We believe that repentance towards God, faith in our Lord Jesus Christ, and regeneration by the Holy Spirit, are necessary to salvation.",
    "We believe that we are justified by grace through faith in our Lord Jesus Christ, and that he that believeth hath the witness in himself.",
    "We believe that continuance in a state of salvation depends upon continued obedient faith in Christ.",
    "We believe that it is the privilege of all believers to be wholly sanctified, and that their whole spirit and soul and body may be preserved blameless unto the coming of our Lord Jesus Christ.",
    "We believe in the immortality of the soul, in the resurrection of the body, in the general judgment at the end of the world, in the eternal happiness of the righteous, and in the endless punishment of the wicked."
  ];

  let doctrineIndex = 0;
  function renderDoctrine() {
    $("doctrineTitle").textContent = `Salvation Army Doctrine #${doctrineIndex + 1}`;
    $("doctrineText").textContent = DOCTRINES[doctrineIndex];
  }

  // ---------- Scripture dataset ----------
  const JSON_CANDIDATES = [
    "nlt_for_app_365.json",
    "nlt_for_app_300.json",
    "nlt_for_app_730.json",
    "nlt_for_app.json"
  ];

  let scriptures = [];   // [{ref,text}]
  let scriptureIndex = 0;

  function normalizeScripturePayload(payload) {
    // Accept: array of {ref,text} OR {verses:[...]} OR {items:[...]}
    if (Array.isArray(payload)) return payload;
    if (payload && Array.isArray(payload.verses)) return payload.verses;
    if (payload && Array.isArray(payload.items)) return payload.items;
    if (payload && Array.isArray(payload.data)) return payload.data;
    return null;
  }

  async function loadFirstAvailableJSON() {
    for (const name of JSON_CANDIDATES) {
      try {
        const r = await fetch(`${name}?v=${Date.now()}`, { cache: "no-store" });
        if (!r.ok) continue;
        const raw = await r.json();
        const arr = normalizeScripturePayload(raw);
        if (!arr || !arr.length) continue;

        // Map to strict {ref,text}
        const mapped = arr.map(v => ({
          ref: (v.ref || v.reference || v.scripture_ref || "").toString().trim(),
          text: (v.text || v.scripture_text || "").toString().trim()
        })).filter(v => v.ref && v.text);

        if (mapped.length) return { name, data: mapped };
      } catch (_) {}
    }
    return null;
  }

  function renderScripture() {
    if (!scriptures.length) {
      $("scriptureRef").textContent = "No scripture loaded";
      $("scriptureText").textContent = "No JSON file found. Put one of: nlt_for_app_365.json, nlt_for_app_300.json, nlt_for_app_730.json, nlt_for_app.json";
      return;
    }
    const v = scriptures[scriptureIndex];
    $("scriptureRef").textContent = v.ref;
    $("scriptureText").textContent = v.text;
  }

  async function copyToClipboard(text) {
    try {
      await navigator.clipboard.writeText(text);
    } catch (_) {
      // fallback
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
    }
  }

  // ---------- Prayer List persistence ----------
  const LIST_KEY = "PRAYER_ROOM_LIST_V1";
  let listUndo = null;

  function loadList() {
    const saved = localStorage.getItem(LIST_KEY);
    $("listText").value = saved || "";
    listUndo = saved || "";
  }
  function saveList() {
    localStorage.setItem(LIST_KEY, $("listText").value || "");
    listUndo = $("listText").value || "";
  }
  function undoList() {
    if (listUndo !== null) $("listText").value = listUndo;
  }

  // ---------- Prayers by date (with undo/redo) ----------
  function prayerKey(iso) { return `PRAYER_ROOM_PRAYER_${iso}`; }
  function stackKey(iso, which) { return `PRAYER_ROOM_STACK_${which}_${iso}`; }

  function getStack(iso, which) {
    try { return JSON.parse(localStorage.getItem(stackKey(iso, which)) || "[]"); }
    catch { return []; }
  }
  function setStack(iso, which, arr) {
    localStorage.setItem(stackKey(iso, which), JSON.stringify(arr));
  }

  function loadPrayerForDate(iso) {
    const val = localStorage.getItem(prayerKey(iso)) || "";
    $("prayerText").value = val;
    // reset stacks
    setStack(iso, "UNDO", [val]);
    setStack(iso, "REDO", []);
  }

  function savePrayerForDate(iso) {
    const val = $("prayerText").value || "";
    localStorage.setItem(prayerKey(iso), val);

    const undo = getStack(iso, "UNDO");
    if (!undo.length || undo[undo.length - 1] !== val) undo.push(val);
    setStack(iso, "UNDO", undo);
    setStack(iso, "REDO", []);
  }

  function pushUndoOnEdit(iso) {
    const val = $("prayerText").value || "";
    const undo = getStack(iso, "UNDO");
    if (!undo.length || undo[undo.length - 1] !== val) {
      undo.push(val);
      setStack(iso, "UNDO", undo);
      setStack(iso, "REDO", []);
    }
  }

  function undoPrayer(iso) {
    const undo = getStack(iso, "UNDO");
    const redo = getStack(iso, "REDO");
    if (undo.length <= 1) return;
    const current = undo.pop();
    redo.push(current);
    setStack(iso, "UNDO", undo);
    setStack(iso, "REDO", redo);
    const prev = undo[undo.length - 1] || "";
    $("prayerText").value = prev;
    localStorage.setItem(prayerKey(iso), prev);
  }

  function redoPrayer(iso) {
    const undo = getStack(iso, "UNDO");
    const redo = getStack(iso, "REDO");
    if (!redo.length) return;
    const next = redo.pop();
    undo.push(next);
    setStack(iso, "UNDO", undo);
    setStack(iso, "REDO", redo);
    $("prayerText").value = next;
    localStorage.setItem(prayerKey(iso), next);
  }

  // ---------- Compute “today” indices ----------
  function computeDayIndex(selectedISO) {
    const delta = daysBetweenISO(ANCHOR_ISO, selectedISO);
    return delta;
  }

  function setIndicesForDate(iso) {
    const dayIndex = computeDayIndex(iso);

    doctrineIndex = ((dayIndex % 11) + 11) % 11;
    renderDoctrine();

    if (scriptures.length) {
      scriptureIndex = ((dayIndex % scriptures.length) + scriptures.length) % scriptures.length;
      renderScripture();
    }
  }

  // ---------- Wire UI ----------
  function wire() {
    // Init date
    const today = isoToday();
    $("prayerDate").value = today;

    loadList();
    loadPrayerForDate(today);

    $("todayBtn").onclick = () => {
      const t = isoToday();
      $("prayerDate").value = t;
      loadPrayerForDate(t);
      setIndicesForDate(t);
    };

    $("saveList").onclick = saveList;
    $("undoList").onclick = undoList;

    $("savePrayer").onclick = () => savePrayerForDate($("prayerDate").value);
    $("undoPrayer").onclick = () => undoPrayer($("prayerDate").value);
    $("redoPrayer").onclick = () => redoPrayer($("prayerDate").value);

    // Track edits to prayer text (lightweight)
    let editTimer = null;
    $("prayerText").addEventListener("input", () => {
      const iso = $("prayerDate").value;
      clearTimeout(editTimer);
      editTimer = setTimeout(() => pushUndoOnEdit(iso), 350);
    });

    $("prayerDate").addEventListener("change", () => {
      const iso = $("prayerDate").value;
      loadPrayerForDate(iso);
      setIndicesForDate(iso);
    });

    $("prevDoctrine").onclick = () => {
      doctrineIndex = (doctrineIndex + 10) % 11;
      renderDoctrine();
    };
    $("nextDoctrine").onclick = () => {
      doctrineIndex = (doctrineIndex + 1) % 11;
      renderDoctrine();
    };

    $("prevScripture").onclick = () => {
      if (!scriptures.length) return;
      scriptureIndex = (scriptureIndex - 1 + scriptures.length) % scriptures.length;
      renderScripture();
    };
    $("nextScripture").onclick = () => {
      if (!scriptures.length) return;
      scriptureIndex = (scriptureIndex + 1) % scriptures.length;
      renderScripture();
    };
    $("copyScripture").onclick = async () => {
      const ref = $("scriptureRef").textContent || "";
      const text = $("scriptureText").textContent || "";
      await copyToClipboard(`${ref}\n${text}`.trim());
    };
  }

  // ---------- Boot ----------
  (async () => {
    wire();

    const found = await loadFirstAvailableJSON();
    if (found) {
      scriptures = found.data;
      // set by today
      const iso = $("prayerDate").value || isoToday();
      setIndicesForDate(iso);
    } else {
      renderScripture();
      // doctrine still rotates
      setIndicesForDate($("prayerDate").value || isoToday());
    }
  })();

})();
</script>
</body>
</html>

