<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Prayer Room</title>
  <style>
    :root{
      --bg: #efe8d6;
      --panel: #f6f1e2;
      --border: #1b1b1b;

      --banner: #a40000;

      --scripture-bg: #dff1e3;
      --scripture-border: #4a8f63;

      /* Prayer List banner: rich yellow (Salvation Army feel) */
      --list-header: #f2c200;
      /* Prayer List background: rich pastel blue */
      --list-bg: #cfe2ff;

      --prayer-header: #1f3f8a;
      /* Daily Prayer: rich pastel blue */
      --prayer-bg: #d6e6ff;

      --pet-header: #2f7d32;
      /* Daily Petitions: rich pastel salmon */
      --pet-bg: #f3b6ad;

      --doctrine-bg: #0b2c6e;
      --doctrine-border: #f2c200;
      --doctrine-ivory: #f7f1e1;

      --btn-bg: #ffffff;
      --btn-border: #222;

      --forest: #0b3d2e;

      --editor-max-w: 520px;
    }

    *{ box-sizing: border-box; }

    html, body{
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: #111;
    }

    /* 80% width on iPad/landscape/desktop */
    .shell{
      height: 100vh;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 10px;
    }
    .app{
      height: 100%;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
    }
    @media (min-width: 820px){
      .app{ width: min(80vw, 1300px); }
    }

    .header{
      background: var(--banner);
      color: #fff;
      border-radius: 12px;
      padding: 12px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex: 0 0 auto;
    }

    .title{
      font-weight: 900;
      font-size: 20px;
      line-height: 1.1;
    }

    .header-right{
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .pill{
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.25);
      color: #fff;
      padding: 7px 10px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 12px;
      white-space: nowrap;
    }

    .btn{
      appearance: none;
      -webkit-appearance: none;
      border: 2px solid var(--btn-border);
      background: var(--btn-bg);
      color: #111;
      border-radius: 12px;
      padding: 8px 12px;
      font-weight: 900;
      font-size: 13px;
      cursor: pointer;
      touch-action: manipulation;
    }
    .btn:active{ transform: translateY(1px); }

    .panel{
      border: 2px solid var(--border);
      border-radius: 14px;
      background: var(--panel);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .panel-header{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      font-weight: 950;
      flex: 0 0 auto;
      flex-wrap: wrap;
    }

    .panel-body{
      padding: 10px 12px;
      overflow: auto;
      min-height: 0;
      flex: 1 1 auto;
      -webkit-overflow-scrolling: touch;
    }

    /* Scripture reduced height + tighter body */
    .scripture{
      background: var(--scripture-bg);
      border-color: var(--scripture-border);
      max-height: 120px;
    }
    .scripture .panel-body{ padding: 8px 10px; }
    .scripture-controls{ display:flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }
    .scrRef{
      text-align:center;
      font-weight: 950;
      font-size: 17px;
      margin: 2px 0 5px;
      color: #111;
    }
    .scrText{
      text-align:center;
      font-weight: 850;
      font-size: 15px;
      line-height: 1.22;
      white-space: pre-wrap;
      color: var(--forest);
    }

    /* Main layout */
    .main{
      flex: 1 1 auto;
      min-height: 0;
      display: grid;
      grid-template-columns: 1fr;
      grid-template-rows: auto auto;
      gap: 10px;
    }

    @media (min-width: 820px){
      .main{
        /* slightly narrower list column so Daily Prayer gets more room */
        grid-template-columns: 260px 1fr;
        grid-template-rows: 1fr;
      }
    }

    /* Shared textarea behavior: remove box-in-box */
    textarea{
      width: 100%;
      height: 100%;
      min-height: 0;
      resize: none;
      border: 0;
      border-radius: 0;
      padding: 12px;
      font-size: 16px;
      font-weight: 800;
      outline: none;
      background: transparent;      /* KEY: lets panel color show */
      color: var(--forest);
      display:block;
      -webkit-overflow-scrolling: touch;
    }
    textarea::placeholder{
      color: rgba(11,61,46,0.65);
      font-weight: 750;
    }

    /* Prayer list (pastel BLUE, banner YELLOW) */
    .list .panel-header{ background: var(--list-header); color:#111; }
    .list .panel-body{
      background: var(--list-bg);
      padding: 0;                 /* KEY: textarea provides padding */
      display:flex;
      align-items:stretch;
    }
    .list textarea{ flex: 1 1 auto; }
    .list-controls{ display:flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }

    /* Right split 2/3 + 1/3 */
    .right{
      min-height: 0;
      display: grid;
      grid-template-rows: 2fr 1fr;
      gap: 10px;
    }

    .prayer .panel-header{ background: var(--prayer-header); color:#fff; }
    .prayer .panel-body{
      background: var(--prayer-bg);
      padding: 0;
      display:flex;
      justify-content:center;
      align-items:stretch;
    }

    .petitions .panel-header{ background: var(--pet-header); color:#fff; }
    .petitions .panel-body{
      background: var(--pet-bg);
      padding: 0;
      display:flex;
      justify-content:center;
      align-items:stretch;
    }

    /* Narrow prayer/petitions editor area while keeping full panel color visible */
    .prayer textarea, .petitions textarea{
      max-width: var(--editor-max-w);
      flex: 1 1 auto;
    }

    .date-row{
      display:flex;
      gap: 8px;
      align-items:center;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    .date-row label{ font-weight: 950; color: #fff; }
    .date-row input[type="date"]{
      font-weight: 950;
      padding: 6px 10px;
      border-radius: 12px;
      border: 2px solid #1d1d1d;
      font-size: 13px;
      background: #fff;
      color: #111;
    }

    .row-controls{ display:flex; gap: 8px; flex-wrap: wrap; justify-content:flex-end; }

    /* Doctrine reduced height; centered; ivory text */
    .doctrine{
      background: var(--doctrine-bg);
      border-color: var(--doctrine-border);
      max-height: 120px; /* reduced */
    }
    .doctrine .panel-header{
      background: transparent;
      color: #ffd100;
      padding-bottom: 6px;
      justify-content: center;
      text-align: center;
    }
    .docTitle{
      font-weight: 950;
      font-size: 18px;
      color: #ffd100;
      text-align: center;
      width: 100%;
    }
    .doctrine .panel-body{
      background: transparent;
      color: var(--doctrine-ivory);
      padding: 6px 10px 10px;
    }
    .docText{
      text-align: center;
      font-weight: 900;
      font-size: 14px;
      line-height: 1.22;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <div class="shell">
    <div class="app">

      <div class="header">
        <div class="title" id="hdrTitle">Prayer Room</div>
        <div class="header-right">
          <div class="pill" id="hdrDate"></div>
          <button class="btn" id="btnName">Name</button>
        </div>
      </div>

      <section class="panel scripture" aria-label="Daily Scripture">
        <div class="panel-header">
          <div style="font-size:16px;">Daily Scripture</div>
          <div class="scripture-controls">
            <button class="btn" id="btnCopyScripture">Copy</button>
          </div>
        </div>
        <div class="panel-body">
          <div class="scrRef" id="scrRef">Loading…</div>
          <div class="scrText" id="scrText"></div>
        </div>
      </section>

      <div class="main">

        <section class="panel list" aria-label="Daily Prayer List">
          <div class="panel-header">
            <div style="font-size:16px;">Daily Prayer List</div>
            <div class="list-controls">
              <button class="btn" id="btnSaveList">Save</button>
              <button class="btn" id="btnUndoList">Undo</button>
            </div>
          </div>
          <div class="panel-body">
            <textarea id="taList" spellcheck="false" placeholder="Paste or type names here…"></textarea>
          </div>
        </section>

        <div class="right">

          <section class="panel prayer" aria-label="Daily Prayer">
            <div class="panel-header">
              <div style="font-size:16px;">Daily Prayer</div>
              <div class="date-row">
                <label for="datePick">Date</label>
                <input id="datePick" type="date" />
                <button class="btn" id="btnToday">Today</button>
                <button class="btn" id="btnSavePrayer">Save</button>
                <button class="btn" id="btnUndoPrayer">Undo</button>
                <button class="btn" id="btnRedoPrayer">Redo</button>
              </div>
            </div>
            <div class="panel-body">
              <textarea id="taPrayer" spellcheck="false" placeholder="Write your daily prayer for the selected date…"></textarea>
            </div>
          </section>

          <section class="panel petitions" aria-label="Daily Petitions">
            <div class="panel-header">
              <div style="font-size:16px;">Daily Petitions</div>
              <div class="row-controls">
                <button class="btn" id="btnSavePets">Save</button>
                <button class="btn" id="btnUndoPets">Undo</button>
                <button class="btn" id="btnRedoPets">Redo</button>
              </div>
            </div>
            <div class="panel-body">
              <textarea id="taPets" spellcheck="false" placeholder="Write your petitions for the selected date…"></textarea>
            </div>
          </section>

        </div>
      </div>

      <section class="panel doctrine" aria-label="Salvation Army Doctrine">
        <div class="panel-header">
          <div class="docTitle" id="docTitle">Salvation Army Doctrine</div>
        </div>
        <div class="panel-body">
          <div class="docText" id="docText"></div>
        </div>
      </section>

    </div>
  </div>

  <script>
    function pad2(n){ return String(n).padStart(2,'0'); }
    function ymd(d){ return d.getFullYear() + '-' + pad2(d.getMonth()+1) + '-' + pad2(d.getDate()); }
    function parseYMD(s){
      const [y,m,dd] = s.split('-').map(Number);
      return new Date(y, (m-1), dd, 12, 0, 0, 0);
    }
    function dayOfYear(d){
      const start = new Date(d.getFullYear(), 0, 1, 12, 0, 0, 0);
      return Math.floor((d - start) / 86400000);
    }

    async function fetchJsonWithCacheBust(url){
      const bust = 'v=' + Date.now();
      const sep = url.includes('?') ? '&' : '?';
      const res = await fetch(url + sep + bust, { cache: 'no-store' });
      if(!res.ok) throw new Error('HTTP ' + res.status);
      return await res.json();
    }

    async function loadScriptureData(){
      try{ return await fetchJsonWithCacheBust('nlt_for_app_365.json'); }
      catch(e1){
        try{ return await fetchJsonWithCacheBust('nlt_for_app.json'); }
        catch(e2){ throw new Error('Scripture JSON failed'); }
      }
    }

    const DOCTRINES = [
      "We believe that the Scriptures of the Old and New Testaments were given by inspiration of God, and that they only constitute the Divine rule of Christian faith and practice.",
      "We believe that there is only one God, who is infinitely perfect, the Creator, Preserver, and Governor of all things, and who is the only proper object of religious worship.",
      "We believe that there are three persons in the Godhead—the Father, the Son, and the Holy Ghost, undivided in essence and co-equal in power and glory.",
      "We believe that in the person of Jesus Christ the Divine and human natures are united, so that He is truly and properly God and truly and properly man.",
      "We believe that our first parents were created in a state of innocency, but by their disobedience they lost their purity and happiness, and that in consequence of their fall all men have become sinners, totally depraved, and as such are justly exposed to the wrath of God.",
      "We believe that the Lord Jesus Christ has by His suffering and death made an atonement for the whole world, so that whosoever will may be saved.",
      "We believe that repentance toward God, faith in our Lord Jesus Christ, and regeneration by the Holy Spirit are necessary to salvation.",
      "We believe that we are justified by grace through faith in our Lord Jesus Christ, and that he that believeth hath the witness in himself.",
      "We believe that continuance in a state of salvation depends upon continued obedient faith in Christ.",
      "We believe that it is the privilege of all believers to be wholly sanctified, and that their whole spirit and soul and body may be preserved blameless unto the coming of our Lord Jesus Christ.",
      "We believe in the immortality of the soul; in the resurrection of the body; in the general judgment at the end of the world; in the eternal happiness of the righteous; and in the endless punishment of the wicked."
    ];

    const DOCTRINE_EPOCH = new Date(2026,0,1,12,0,0,0);
    function doctrineIndexForDate(d){
      const days = Math.floor((d - DOCTRINE_EPOCH) / 86400000);
      return ((days % 11) + 11) % 11;
    }

    function normalizeScriptureItem(item){
      const ref = item.ref || item.scripture_ref || item.reference || item.verse_ref || item.verseRef || "";
      const text = item.text || item.scripture_text || item.verse || item.verse_text || item.verseText || "";
      const date = item.date || item.day || item.ymd || item.dayKey || "";
      return { ref, text, date };
    }

    let scriptureData = null;
    let viewDate = new Date();
    viewDate.setHours(12,0,0,0);

    const stacks = {
      list: { undo: [], redo: [] },
      prayer: { undo: [], redo: [] },
      pets: { undo: [], redo: [] }
    };

    const hdrTitle = document.getElementById('hdrTitle');
    const hdrDate  = document.getElementById('hdrDate');
    const btnName  = document.getElementById('btnName');

    const scrRef = document.getElementById('scrRef');
    const scrText = document.getElementById('scrText');
    const btnCopyScripture = document.getElementById('btnCopyScripture');

    const taList = document.getElementById('taList');
    const btnSaveList = document.getElementById('btnSaveList');
    const btnUndoList = document.getElementById('btnUndoList');

    const datePick = document.getElementById('datePick');
    const btnToday = document.getElementById('btnToday');

    const taPrayer = document.getElementById('taPrayer');
    const btnSavePrayer = document.getElementById('btnSavePrayer');
    const btnUndoPrayer = document.getElementById('btnUndoPrayer');
    const btnRedoPrayer = document.getElementById('btnRedoPrayer');

    const taPets = document.getElementById('taPets');
    const btnSavePets = document.getElementById('btnSavePets');
    const btnUndoPets = document.getElementById('btnUndoPets');
    const btnRedoPets = document.getElementById('btnRedoPets');

    const docTitle = document.getElementById('docTitle');
    const docText = document.getElementById('docText');

    const K = {
      first: 'prayerRoom.firstName',
      list:  'prayerRoom.dailyList',
      prayer: (d) => `prayerRoom.prayer.${ymd(d)}`,
      pets:   (d) => `prayerRoom.petitions.${ymd(d)}`
    };

    function getFirstName(){ return (localStorage.getItem(K.first) || '').trim(); }
    function setFirstName(name){ localStorage.setItem(K.first, name.trim()); }

    function renderHeader(){
      const name = getFirstName();
      hdrTitle.textContent = name ? `${name}'s Prayer Room` : "Prayer Room";
      const fmt = new Intl.DateTimeFormat(undefined, { weekday:'long', year:'numeric', month:'long', day:'numeric' });
      hdrDate.textContent = fmt.format(viewDate);
    }

    function ensureName(){
      let name = getFirstName();
      if(!name){
        name = (prompt("First name (for header):", "") || "").trim();
        if(name) setFirstName(name);
      }
      renderHeader();
    }

    function findScriptureForDate(d){
      if(!Array.isArray(scriptureData) || scriptureData.length === 0) return null;
      const key = ymd(d);

      for(const raw of scriptureData){
        const it = normalizeScriptureItem(raw);
        if(it.date && String(it.date).includes(key)) return it;
      }

      const idx = dayOfYear(d);
      const raw = scriptureData[idx % scriptureData.length];
      return raw ? normalizeScriptureItem(raw) : null;
    }

    function renderScripture(){
      const it = findScriptureForDate(viewDate);
      if(!it){
        scrRef.textContent = "Scripture not loaded";
        scrText.textContent = "";
        return;
      }
      scrRef.textContent = it.ref || "Daily Scripture";
      scrText.textContent = it.text || "";
    }

    async function copyScripture(){
      const text = (scrRef.textContent + "\n" + scrText.textContent).trim();
      try{
        await navigator.clipboard.writeText(text);
        btnCopyScripture.textContent = "Copied";
        setTimeout(()=> btnCopyScripture.textContent = "Copy", 900);
      }catch(e){
        alert("Copy failed in this browser. You can highlight and copy manually.");
      }
    }

    function renderDoctrine(){
      const idx = doctrineIndexForDate(viewDate);
      docTitle.textContent = `Salvation Army Doctrine #${idx+1}`;
      docText.textContent = DOCTRINES[idx];
    }

    function loadList(){
      taList.value = localStorage.getItem(K.list) || "";
      stacks.list.undo = [taList.value];
      stacks.list.redo = [];
    }

    function loadEditorsForDate(){
      datePick.value = ymd(viewDate);
      taPrayer.value = localStorage.getItem(K.prayer(viewDate)) || "";
      taPets.value   = localStorage.getItem(K.pets(viewDate)) || "";

      stacks.prayer.undo = [taPrayer.value];
      stacks.prayer.redo = [];
      stacks.pets.undo = [taPets.value];
      stacks.pets.redo = [];
    }

    function saveList(){
      localStorage.setItem(K.list, taList.value);
      btnSaveList.textContent = "Saved";
      setTimeout(()=> btnSaveList.textContent = "Save", 900);
    }
    function savePrayer(){
      localStorage.setItem(K.prayer(viewDate), taPrayer.value);
      btnSavePrayer.textContent = "Saved";
      setTimeout(()=> btnSavePrayer.textContent = "Save", 900);
    }
    function savePets(){
      localStorage.setItem(K.pets(viewDate), taPets.value);
      btnSavePets.textContent = "Saved";
      setTimeout(()=> btnSavePets.textContent = "Save", 900);
    }

    function wireUndoRedo(textarea, stackObj){
      textarea.addEventListener('input', () => {
        const current = textarea.value;
        const last = stackObj.undo.length ? stackObj.undo[stackObj.undo.length - 1] : null;
        if(last !== current){
          stackObj.undo.push(current);
          if(stackObj.undo.length > 60) stackObj.undo.shift();
        }
        stackObj.redo = [];
      });
    }
    function doUndo(textarea, stackObj){
      if(stackObj.undo.length < 2) return;
      const cur = stackObj.undo.pop();
      stackObj.redo.push(cur);
      textarea.value = stackObj.undo[stackObj.undo.length - 1];
    }
    function doRedo(textarea, stackObj){
      if(stackObj.redo.length === 0) return;
      const next = stackObj.redo.pop();
      stackObj.undo.push(next);
      textarea.value = next;
    }

    function setViewDate(d){
      viewDate = new Date(d.getTime());
      viewDate.setHours(12,0,0,0);

      renderHeader();
      renderScripture();
      renderDoctrine();
      loadEditorsForDate();
    }

    async function init(){
      loadList();
      loadEditorsForDate();
      ensureName();

      try{ scriptureData = await loadScriptureData(); }
      catch(e){ scriptureData = null; }

      renderHeader();
      renderScripture();
      renderDoctrine();

      btnName.addEventListener('click', () => {
        const current = getFirstName();
        const next = prompt("First name:", current || "");
        if(next !== null){
          const name = String(next).trim();
          if(name) setFirstName(name);
          else localStorage.removeItem(K.first);
          renderHeader();
        }
      });

      btnCopyScripture.addEventListener('click', copyScripture);

      btnSaveList.addEventListener('click', saveList);
      btnUndoList.addEventListener('click', ()=> doUndo(taList, stacks.list));

      btnToday.addEventListener('click', ()=> setViewDate(new Date()));
      datePick.addEventListener('change', ()=> { if(datePick.value) setViewDate(parseYMD(datePick.value)); });

      btnSavePrayer.addEventListener('click', savePrayer);
      btnUndoPrayer.addEventListener('click', ()=> doUndo(taPrayer, stacks.prayer));
      btnRedoPrayer.addEventListener('click', ()=> doRedo(taPrayer, stacks.prayer));

      btnSavePets.addEventListener('click', savePets);
      btnUndoPets.addEventListener('click', ()=> doUndo(taPets, stacks.pets));
      btnRedoPets.addEventListener('click', ()=> doRedo(taPets, stacks.pets));

      wireUndoRedo(taList, stacks.list);
      wireUndoRedo(taPrayer, stacks.prayer);
      wireUndoRedo(taPets, stacks.pets);
    }

    init();
  </script>
</body>
</html>

